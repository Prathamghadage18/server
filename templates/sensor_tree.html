{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sensor Management - Tree Layout</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/tree.css' %}">
</head>
<body data-is-superuser="{% if is_superuser %}true{% else %}false{% endif %}">
    <div class="app d-flex">
        <!-- Sidebar Open Button (hidden by default) -->
        <div id="sidebar-open-btn" 
             class="position-absolute z-3 text-xl fw-semibold text-white bg-primary px-2 py-1 rounded m-2 d-flex align-items-center"
             style="display: none; cursor: pointer;">
            ☰
        </div>
        
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar" aria-label="Sidebar">
            <div class="d-flex align-items-center mb-2">
                <!-- <div style="width: 40px; height: 40px; border-radius: 8px; background: #2563eb; display: flex; align-items: center; justify-content: center; color: #fff;">
                    <i class="fas fa-industry" aria-hidden="true"></i>
                </div> -->
                <div class="ms-2 w-100">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h2 style="font-size: 18px; margin-top: 0px; margin-left: 15px;">Product Management</h2>
                            <div style="font-size: 12px; color: #6b7280;">Tree Layout</div>
                        </div>
                        <div>
                            <button id="sidebar-close-btn" 
                                    class="btn btn-sm btn-outline-secondary rounded-circle p-1" 
                                    style="width: 30px; height: 30px; font-size: 18px; line-height: 1;">
                                ×
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Info -->
            {% if user.is_authenticated %}
            <div class="mb-3 p-2" style="background: #f3f4f6; border-radius: 6px;">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div style="font-size: 13px; font-weight: 600;">
                            <i class="fas fa-user me-1"></i> {{ user.username }}
                        </div>
                        <div style="font-size: 11px; color: #6b7280;">
                            {% if is_superuser %}
                                <span class="badge bg-warning text-dark">Superuser</span>
                            {% else %}
                                <span class="badge bg-primary">Normal User</span>
                            {% endif %}
                        </div>
                    </div>
                    <a href="{% url 'logout' %}" class="btn btn-sm btn-outline-danger" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </a>
                </div>
            </div>
            {% endif %}

            <div class="mb-2 position-relative">
                <i class="fas fa-search position-absolute" 
                   style="left: 12px; top: 10px; color: #9ca3af;" 
                   aria-hidden="true"></i>
                <input id="search-input" 
                       type="text" 
                       placeholder="Search nodes, sensors, values..." 
                       class="form-control ps-5" 
                       aria-label="Search nodes">
            </div>

            <!-- Info Box -->
            <div class="alert alert-info mb-3" style="font-size: 12px; padding: 8px;">
                <i class="fas fa-info-circle me-1"></i>
                <strong>Tree auto-loads from database!</strong><br>
                {% if is_superuser %}
                Upload Excel to save data permanently (one-time only).
                {% else %}
                Upload Excel to view different data temporarily.
                {% endif %}
            </div>

            <div class="mb-3">
                <input id="file-input" 
                       type="file" 
                       accept=".xlsx,.xls" 
                       class="form-control mb-2">
                
                <!-- Upload button (behavior depends on user role) -->
                <button id="upload-btn" 
                        class="btn btn-primary w-100" 
                        disabled
                        title="{% if is_superuser %}Upload Excel and save to database (one-time only){% else %}Upload Excel for viewing only (doesn't save to database){% endif %}">
                    <i class="fas fa-upload me-1"></i>
                    {% if is_superuser %}
                    Upload to Database (Permanent)
                    {% else %}
                    Upload & View Only
                    {% endif %}
                </button>
            </div>

            <div class="d-flex gap-2 mb-3" role="group" aria-label="Expand or collapse levels step by step">
                <button id="expand-next-btn" 
                        class="btn btn-success flex-grow-1 d-flex align-items-center justify-content-center" 
                        title="Expand next level" 
                        disabled>
                    <i class="fas fa-expand-arrows-alt me-2" aria-hidden="true"></i>
                    <strong>Expand Next</strong>
                </button>
                <button id="collapse-prev-btn" 
                        class="btn btn-danger flex-grow-1 d-flex align-items-center justify-content-center" 
                        title="Collapse previous level" 
                        disabled>
                    <i class="fas fa-compress-arrows-alt me-2" aria-hidden="true"></i>
                    <strong>Collapse Prev</strong>
                </button>
            </div>

            <div class="overview p-2 mb-3">
                <div style="font-size: 13px; font-weight: 700; color: #92400e;">System Overview</div>
                <div class="d-flex gap-2 mt-2">
                    <div class="stat p-2 bg-white rounded shadow-sm w-50 text-center">
                        <div id="stat-total" style="font-size: 18px; font-weight: 800; color: #111827;">0</div>
                        <div style="font-size: 12px; color: #6b7280;">Total Sensors</div>
                    </div>
                    <div class="stat p-2 bg-white rounded shadow-sm w-50 text-center">
                        <div id="stat-online" style="font-size: 18px; font-weight: 800; color: #059669;">0</div>
                        <div style="font-size: 12px; color: #6b7280;">Online</div>
                    </div>
                </div>
                <div class="d-flex gap-2 mt-2">
                    <div class="stat p-2 bg-white rounded shadow-sm w-50 text-center">
                        <div id="stat-warning" style="font-size: 18px; font-weight: 800; color: #f59e0b;">0</div>
                        <div style="font-size: 12px; color: #6b7280;">Warning</div>
                    </div>
                    <div class="stat p-2 bg-white rounded shadow-sm w-50 text-center">
                        <div id="stat-offline" style="font-size: 18px; font-weight: 800; color: #ef4444;">0</div>
                        <div style="font-size: 12px; color: #6b7280;">Offline</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Canvas -->
        <main class="main w-100 overflow-scroll hide-scrollbar">
            <!-- Loading State -->
            <div id="loading-message" 
                 class="align-items-center justify-content-center h-100 text-secondary fs-5 fw-semibold"
                 style="display: none;">
                Uploading and processing Excel file...
            </div>

            <!-- Error State -->
            <div id="error-message" 
                 class="align-items-center justify-content-center h-100 text-danger fs-5 fw-semibold"
                 style="display: none;">
                Failed to upload Excel file.<br>
                <span id="error-text"></span>
            </div>

            <!-- No Data State -->
            <div id="no-data-message" 
                 class="d-flex align-items-center justify-content-center h-100 text-secondary fs-5 fw-semibold">
                No tree data loaded. Please upload an Excel file using the sidebar.
            </div>

            <!-- Canvas Content -->
            <div id="canvas-content" class="h-100" style="display: none;">
                <div id="canvas-container" class="canvas hide-scrollbar">
                    <!-- Navigation Bar -->
                    <div class="position-fixed" 
                         style="z-index: 50; width: fit-content; margin-left: 2rem; top: 0.5rem; padding: 0.5rem; border-radius: 0.375rem; display: flex; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); background: white;">
                        <strong style="font-size: 13px;">Navigation:</strong>
                        <span id="breadcrumb-text" 
                              class="ms-2" 
                              style="color: #374151; font-size: 13px;">
                            Click an expand (+) button to highlight a path
                        </span>
                        <div class="ms-4 d-flex align-items-center gap-2">
                            <button id="layout-toggle-btn" 
                                    class="btn btn-sm btn-outline-secondary" 
                                    title="Toggle layout orientation">
                                Vertical
                            </button>
                            <span class="text-muted" style="font-size: 12px;">
                                Mode: <span id="layout-mode-text">horizontal</span>
                            </span>
                        </div>
                    </div>

                    <!-- SVG for connectors -->
                    <svg id="connector-svg" 
                         class="connector-svg" 
                         xmlns="http://www.w3.org/2000/svg">
                    </svg>

                    <!-- Tree Container -->
                    <div id="tree-container" 
                         class="tree-container mb-5">
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- JavaScript Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Application Scripts -->
    <script src="{% static 'js/normalizeData.js' %}"></script>
    <script src="{% static 'js/layout.js' %}"></script>
    <script src="{% static 'js/treeApp-core.js' %}"></script>
    <script src="{% static 'js/treeApp-layout.js' %}"></script>
    <script src="{% static 'js/treeApp-vertical.js' %}"></script>
    <script src="{% static 'js/treeApp-render.js' %}"></script>
    <script src="{% static 'js/treeApp-events.js' %}"></script>
    
    <!-- Initialize App -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const app = new TreeApp();
            app.init();
            window.treeApp = app; // For debugging
        });
    </script>
</body>
</html>

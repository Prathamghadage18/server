{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Note Editor</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body class="bg-light">
    <div class="container py-4">
      <div class="d-flex align-items-center mb-3">
        <h1 class="h4 mb-0">Node Note</h1>
        <span class="ms-2 text-muted small"
          >for <code>{{ node_id }}</code></span
        >
        {% if last_updated %}
        <span class="ms-auto small text-secondary"
          >Last saved: {{ last_updated|date:"Y-m-d H:i" }}</span
        >
        {% endif %}
      </div>

      <div
        class="alert alert-info d-flex justify-content-between align-items-center"
      >
        <span>
          <i class="fas fa-user me-2"></i>
          Logged in as: <strong>{{ user.username }}</strong>
          {% if is_superuser %}
          <span class="badge bg-warning text-dark ms-2">Superuser</span>
          {% else %}
          <span class="badge bg-primary ms-2">Normal User</span>
          {% endif %}
        </span>
        <a href="{% url 'tree-view' %}" class="btn btn-sm btn-outline-primary">
          <i class="fas fa-arrow-left me-1"></i> Back to Tree
        </a>
      </div>

      <div class="card shadow-sm">
        <div class="card-body">
          <form method="post" novalidate>
            {% csrf_token %}
            <div class="mb-2">
              {{ form.content.label_tag }} {{ form.content }}  
              {% if form.content.errors %}
              <div class="text-danger small">
                {{ form.content.errors|striptags }}
              </div>
              {% endif %}
              <div class="d-flex justify-content-between mt-1 small text-muted">
                <span id="line-counter">0 / 10000 lines</span>
                <span id="char-counter">0 chars</span>
              </div>
            </div>
            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save me-1"></i> Save
              </button>
              <a
                class="btn btn-outline-secondary"
                href="javascript:window.close()"
                >Close</a
              >
            </div>
          </form>
        </div>
      </div>

      <div class="mt-3">
        <div class="alert alert-secondary small mb-0">
          <strong>Note:</strong>
          <ul class="mb-0 mt-1">
            <li>A timestamp line will be appended automatically on save.</li>
            {% if not is_superuser %}
            <li>
              As a normal user, your modifications will be tracked with your
              username and timestamp at the top of the note.
            </li>
            {% endif %}
          </ul>
        </div>
      </div>
    </div>

    <script>
      (function () {
        const textarea = document.querySelector('textarea[name="content"]');
        const lineCounter = document.getElementById("line-counter");
        const charCounter = document.getElementById("char-counter");
        const MAX_LINES = 10000;

        function updateCounters() {
          if (!textarea) return;
          const text = textarea.value
            .replace(/\r\n/g, "\n")
            .replace(/\r/g, "\n");
          const lines = text.split("\n");
          let lineCount = lines.length;
          while (lineCount > 0 && lines[lineCount - 1] === "") lineCount--;
          lineCounter.textContent = `${lineCount} / ${MAX_LINES} lines`;
          charCounter.textContent = `${text.length} chars`;
        }

        function enforceLineLimit(e) {
          const text = textarea.value
            .replace(/\r\n/g, "\n")
            .replace(/\r/g, "\n");
          let lines = text.split("\n");
          let lineCount = lines.length;
          while (lineCount > 0 && lines[lineCount - 1] === "") lineCount--;
          if (lineCount > MAX_LINES) {
            lines = lines.slice(0, MAX_LINES);
            textarea.value = lines.join("\n");
            updateCounters();
          }
        }

        ["input", "change", "keyup"].forEach((evt) => {
          textarea.addEventListener(evt, () => {
            enforceLineLimit();
            updateCounters();
          });
        });

        updateCounters();
      })();
    </script>
  </body>
</html>
